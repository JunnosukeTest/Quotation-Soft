<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>価格表示ツール（格子コピー対応・単一HTML/安全化）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- PapaParse (CSV) -->
  <script defer src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- pdf.js は “必要時に動的ロード” するのでここでは読み込まない -->
  <style>
    body { margin:0; background:#fff; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:#111827; }
    .wrap { max-width:1080px; margin:0 auto; padding:24px; }
    h1 { font-size:22px; color:#065f46; margin:0 0 4px; font-weight:700; }
    .sub { font-size:12px; color:#047857; }
    .card { border:1px solid #a7f3d0; border-radius:16px; margin:24px 0; overflow:hidden; }
    .card h2 { margin:0; padding:12px 16px; border-bottom:1px solid #e5e7eb; color:#065f46; font-weight:600; }
    .card .body { padding:16px; }
    .dz { border:2px dashed #6ee7b7; border-radius:16px; padding:24px; text-align:center; cursor:pointer; background:#fff; }
    .dz p { margin:0; font-size:12px; color:#047857; }
    .btn { padding:6px 10px; border-radius:8px; border:1px solid #a7f3d0; background:#fff; color:#047857; font-weight:600; cursor:pointer; }
    .btn.primary { background:#059669; border-color:#059669; color:#fff; font-weight:700; }
    .btn.danger { border-color:#fecaca; color:#b91c1c; }
    .tblwrap { overflow:auto; border:1px solid #a7f3d0; border-radius:12px; }
    table { width:100%; border-collapse:collapse; table-layout:fixed; font-size:14px; }
    thead { background:#ecfdf5; color:#065f46; }
    th, td { border:1px solid #a7f3d0; padding:8px 10px; text-align:left; }
    td.num { font-variant-numeric: tabular-nums; }
    td.idx { text-align:right; font-size:12px; width:60px; }
    td.model { white-space:nowrap; }
    .muted { color:#9ca3af; }
    .ok { color:#047857; }
    .warn { color:#9a3412; }
    .row-warn { background:#fff7ed; }
    .toolbar { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .toast { position:fixed; right:16px; bottom:16px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px;
             box-shadow:0 10px 15px rgba(0,0,0,.2); opacity:0; transform:translateY(8px); transition:all .2s; z-index:60; }
    .toast.error { background:#9f1239; }
    .toast.show { opacity:1; transform:translateY(0); }
    /* 手動コピーDialog */
    .dlg-mask { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.3); padding:16px; z-index:50; }
    .dlg { width:min(720px,95vw); background:#fff; border:1px solid #e5e7eb; border-radius:14px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.25); }
    .dlg-hd { display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid #e5e7eb; }
    .dlg-tt { font-weight:600; color:#064e3b; }
    .dlg-bd { padding:12px; }
    .dlg-bd p { margin:0 0 8px; font-size:12px; color:#065f46; }
    .dlg-bd textarea { width:100%; height:320px; padding:10px; border:1px solid #e5e7eb; border-radius:8px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header style="display:flex; align-items:center; justify-content:space-between; margin-bottom:24px;">
      <div>
        <h1>価格表示ツール（格子コピー対応・単一HTML/安全化）</h1>
        <div class="sub">背景：白 / 基調：ライトグリーン</div>
      </div>
    </header>

    <section class="card">
      <h2>1. 価格マスタCSVの読み込み</h2>
      <div class="body">
        <div id="csvDz" class="dz" tabindex="0">
          <p>master.csv をドロップ / クリックで選択（縦持ち or 横持ち: SP/NR/HNR 同梱可）</p>
          <input id="csvInput" type="file" accept=".csv" style="display:none" />
        </div>
        <div id="csvMeta" class="sub" style="margin-top:8px;"></div>
      </div>
    </section>

    <section class="card">
      <h2>2. 型式の入力（PDF抽出）</h2>
      <div class="body">
        <div id="pdfDz" class="dz" tabindex="0">
          <p>PDFをドロップ / クリックで選択</p>
          <input id="pdfInput" type="file" accept="application/pdf,.pdf" style="display:none" />
        </div>
        <div id="pdfHint" class="sub" style="margin-top:8px;"></div>
      </div>
    </section>

    <section class="card">
      <h2>3. 見積表（縦列コピーはヘッダの「コピー」ボタン）</h2>
      <div class="body">
        <div class="toolbar">
          <button id="addRowBtn" class="btn" style="display:none;">行を追加</button>
          <button id="estimateBtn" class="btn primary" style="margin-left:auto;">見積表示</button>
        </div>
        <div class="tblwrap">
          <table id="grid">
            <colgroup>
              <col style="width:60px" />
              <col style="width:40%" />
              <col style="width:15%" />
              <col style="width:15%" />
              <col style="width:20%" />
              <col style="width:80px" />
            </colgroup>
            <thead>
              <tr>
                <th>項目</th>
                <th>型式 <button class="btn" data-copycol="1">コピー</button></th>
                <th>定価 <button class="btn" data-copycol="2">コピー</button></th>
                <th>仕入 <button class="btn" data-copycol="3">コピー</button></th>
                <th>備考</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="6" style="padding:24px; text-align:center; color:#047857;">ここに結果が表示されます</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <footer class="sub" style="margin-top:24px;">
      <ul style="margin:0; padding-left:16px;">
        <li>CSVは <b>縦持ち: 型式, 定価, 仕入, 種別(SP/NR/HNR)</b> または <b>横持ち: 型式, SP定価, SP仕入, NR定価, NR仕入, HNR定価, HNR仕入</b> に対応。各種別で<b>最大2種類</b>を保持・表示します。</li>
        <li><b>TNHS- / TEL / FAX / DSP3000 / PC / UL / COM</b> は自動で無視します。型式末尾の <b>( ... )</b> は照合時に無視します。</li>
        <li>ひらがな・漢字・カタカナ（全角・半角）を含む型式は読み込み対象外。PDFはテキストベースのみ対応（画像ベースは抽出不可）。</li>
        <li>列コピーはヘッダの「コピー」ボタンから。失敗時は手動コピー用のダイアログが開きます。</li>
      </ul>
    </footer>
  </div>

  <!-- 手動コピーDialog -->
  <div id="dlgMask" class="dlg-mask" role="dialog" aria-modal="true">
    <div class="dlg">
      <div class="dlg-hd">
        <div id="dlgTitle" class="dlg-tt"></div>
        <button id="dlgClose" class="btn">閉じる</button>
      </div>
      <div class="dlg-bd">
        <p>全選択済みです。Ctrl/Cmd+C でコピーし、Excelの結合セル先頭に貼り付けてください。</p>
        <textarea id="dlgText" readonly></textarea>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ========= 1) エラーフェンス（どこで止まってもトースト表示） ========= */
window.addEventListener("error", (e) => {
  console.error(e.error || e.message || e);
  Toast("実行時エラー: " + (e.message || "unknown"), "error");
});
window.addEventListener("unhandledrejection", (e) => {
  console.error(e.reason || e);
  Toast("Promiseエラー: " + (e.reason?.message || "unknown"), "error");
});

/* ========= 2) Toast ========= */
const Toast = (() => {
  const el = document.getElementById("toast");
  let t = null;
  return (msg, kind="normal") => {
    el.textContent = msg;
    el.classList.remove("error","show");
    if (kind === "error") el.classList.add("error");
    void el.offsetWidth;
    el.classList.add("show");
    clearTimeout(t);
    t = setTimeout(()=> el.classList.remove("show"), 1800);
  };
})();

/* ========= 3) クリップボード ========= */
async function tryWriteClipboard(text) {
  try {
    if (navigator && navigator.clipboard && window && window.isSecureContext) {
      await navigator.clipboard.writeText(text);
      return true;
    }
  } catch {}
  try {
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.setAttribute("readonly", "");
    ta.style.position = "fixed";
    ta.style.top = "-1000px";
    ta.style.left = "-1000px";
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    ta.setSelectionRange(0, ta.value.length);
    const ok = document.execCommand && document.execCommand("copy");
    document.body.removeChild(ta);
    if (ok) return true;
  } catch {}
  return false;
}

/* ========= 4) Helpers ========= */
const stripParen = (s) => String(s ?? "").replace(/\([^)]*\)/g, "").trim();
const isNoise = (s) => /^(TNHS-|TEL|FAX|PC|UL|COM)/i.test(String(s).trim()) || /^DSP3000$/i.test(String(s).trim());
const isValidModel = (s) => {
  const base = stripParen(s);
  if (!/^[A-Z]/.test(base)) return false;
  if (/[ぁ-んァ-ヶーｦ-ﾟ一-龯々]/.test(base)) return false;
  return true;
};
const normalizeKey = (s) => stripParen(s).toUpperCase().replace(/[-\s]/g, "");
const jpYen = (n) => {
  const num = parseFloat(String(n ?? "").toString().replace(/[^0-9.-]/g, ""));
  if (isNaN(num)) return "";
  return new Intl.NumberFormat("ja-JP").format(num);
};

function parseModelList(text) {
  if (!text) return [];
  return text
    .split(/[\n,;\t\s]+/)
    .map(x => stripParen(x))
    .map(x => String(x).trim())
    .filter(x => Boolean(x) && !isNoise(x) && isValidModel(x));
}

function labelFromPdfText(model, pdfText) {
  const m = stripParen(model || "");
  if (!m) return "";
  const lines = String(pdfText || "").split(/\r?\n+/);
  for (const raw of lines) {
    const line = raw.trim();
    if (!line) continue;
    const idx = line.indexOf(m);
    if (idx === -1) continue;
    const left = line.slice(0, idx).trim();
    const hasJP = /[ぁ-んァ-ヶｦ-ﾟ一-龯々]/.test(left);
    if (hasJP) {
      const name = left.replace(/[:：]+\s*$/, "").replace(/^品名[:：]?\s*/, "").slice(-40).trim();
      if (name) return `${name}：${m}`;
    }
  }
  return m;
}

/* ========= 5) 状態 ========= */
let CSV_MAP = null;    // Map<string, Entry>
let PDF_TEXT = "";
let ROWS = [];
let INPLACE = false;

/* ========= 6) CSV 読込 ========= */
function parseCsvToMap(file) {
  return new Promise((resolve, reject) => {
    if (!window.Papa || !Papa.parse) {
      Toast("PapaParseの読み込みに失敗しました","error");
      return reject(new Error("Papa not loaded"));
    }
    Papa.parse(file, {
      header: false,
      skipEmptyLines: true,
      complete: (res) => {
        const rows = res.data;
        const m = new Map();
        let kept = 0;
        const byTypeCount = { SP:0, NR:0, HNR:0 };

        const ensureEntry = (key, model) => {
          const cur = m.get(key);
          if (cur) return cur;
          const entry = { model: String(model).trim(), variantsByType: { SP:[], NR:[], HNR:[] } };
          m.set(key, entry);
          return entry;
        };

        const isHeaderRow = (cells) => {
          const c0 = String(cells?.[0] ?? "").toUpperCase();
          return ["MODEL","品番","型式"].some(h => c0.includes(h));
        };

        for (const row of rows) {
          if (!row || row.length === 0) continue;
          if (isHeaderRow(row)) continue;

          const rawModel = row?.[0];
          if (!rawModel) continue;
          const model = stripParen(rawModel);
          if (isNoise(model) || !isValidModel(model)) continue;
          const key = normalizeKey(model);

          const hasTypeCol = row.length >= 4 && String(row[3] || "").trim() !== "";
          const looksWide = row.length >= 6 && (String(row[1]||"")!=="" || String(row[3]||"")!=="" || String(row[5]||"")!=="");

          if (hasTypeCol && !looksWide) {
            const listPrice = row?.[1] ?? "";
            const cost = row?.[2] ?? "";
            let type = String(row?.[3] ?? "SP").toUpperCase().replace(/[^A-Z]/g, "");
            if (!["SP","NR","HNR"].includes(type)) type = "SP";
            const entry = ensureEntry(key, model);
            const arr = entry.variantsByType[type];
            const sig = String(listPrice) + "|||" + String(cost);
            const hasSame = arr.some(v => (String(v.listPrice) + "|||" + String(v.cost)) === sig);
            if (!hasSame && arr.length < 2) { arr.push({ listPrice, cost }); kept++; byTypeCount[type]++; }
          } else {
            const entry = ensureEntry(key, model);
            const pushIf = (type, lp, cs) => {
              const listPrice = lp ?? "";
              const cost = cs ?? "";
              if (listPrice === "" && cost === "") return;
              const arr = entry.variantsByType[type];
              const sig = String(listPrice) + "|||" + String(cost);
              const hasSame = arr.some(v => (String(v.listPrice) + "|||" + String(v.cost)) === sig);
              if (!hasSame && arr.length < 2) { arr.push({ listPrice, cost }); kept++; byTypeCount[type]++; }
            };
            pushIf("SP", row?.[1], row?.[2]);
            pushIf("NR", row?.[3], row?.[4]);
            pushIf("HNR", row?.[5], row?.[6]);
          }
        }
        resolve({ map: m, meta: { rows: rows.length, kept, uniqueKeys: m.size, byTypeCount } });
      },
      error: (err) => reject(err),
      encoding: "UTF-8",
    });
  });
}

/* ========= 7) PDF （必要時のみ動的ロード） ========= */
async function ensurePdfJsLoaded() {
  if (window.pdfjsLib && window.pdfjsLib.getDocument) return true;
  try {
    await new Promise((resolve, reject) => {
      const s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.js";
      s.async = true;
      s.onload = resolve;
      s.onerror = reject;
      document.head.appendChild(s);
    });
    // worker を同一CDNに設定（失敗しても致命的に落とさない）
    try {
      window.pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.min.js";
    } catch (e) {
      console.warn("Set workerSrc failed:", e);
    }
    return true;
  } catch (e) {
    console.error("pdf.js load failed:", e);
    Toast("PDFモジュールの読み込みに失敗しました（CSVは利用可能です）", "error");
    return false;
  }
}

async function extractTextFromPdf(file) {
  const ok = await ensurePdfJsLoaded();
  if (!ok) return ""; // PDFは使えないが他機能は継続
  try {
    const buf = await file.arrayBuffer();
    const pdf = await window.pdfjsLib.getDocument({ data: buf }).promise;
    let text = "";
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      text += content.items.map(it => (it.str ? it.str + "\n" : "")).join("");
    }
    return text.trim();
  } catch (e) {
    console.error(e);
    Toast("PDF抽出に失敗しました", "error");
    return "";
  }
}

/* ========= 8) UIハンドラ ========= */
const csvDz = document.getElementById("csvDz");
const csvInput = document.getElementById("csvInput");
const csvMeta = document.getElementById("csvMeta");

const pdfDz = document.getElementById("pdfDz");
const pdfInput = document.getElementById("pdfInput");
const pdfHint = document.getElementById("pdfHint");

const addRowBtn = document.getElementById("addRowBtn");
const estimateBtn = document.getElementById("estimateBtn");
const tbody = document.getElementById("tbody");
const grid = document.getElementById("grid");

const dlgMask = document.getElementById("dlgMask");
const dlgTitle = document.getElementById("dlgTitle");
const dlgText = document.getElementById("dlgText");
const dlgClose = document.getElementById("dlgClose");

function openDialog(title, text) {
  dlgTitle.textContent = title;
  dlgText.value = text;
  dlgMask.style.display = "flex";
  dlgText.focus();
  dlgText.select();
}
function closeDialog(){ dlgMask.style.display = "none"; }

/* ========= 9) 表示描画 ========= */
function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

function renderRows() {
  if (!ROWS.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="padding:24px; text-align:center; color:#047857;">ここに結果が表示されます</td></tr>';
    addRowBtn.style.display = INPLACE ? "" : "none";
    estimateBtn.textContent = "見積表示";
    return;
  }
  const rowsHtml = ROWS.map((r, idx) => {
    const rowCls = r.found ? "" : "row-warn";
    const modelCell = INPLACE
      ? `<input data-id="${r.id}" data-k="model" value="${escapeHtml(r.model)}" style="width:100%; padding:6px 8px; border:1px solid #e5e7eb; border-radius:6px;" />`
      : `<span style="font-weight:600; color:#064e3b;">${r.modelLabel ? "品名・型式　" + escapeHtml(r.modelLabel) : escapeHtml(r.model)}</span>`;
    const listCell = INPLACE
      ? `<input data-id="${r.id}" data-k="listPrice" value="${escapeHtml(r.listPrice)}" placeholder="定価" style="width:100%; padding:6px 8px; border:1px solid #e5e7eb; border-radius:6px;" />`
      : (r.listPrice ? `<span>${escapeHtml(jpYen(r.listPrice))}</span>` : `<span class="muted">—</span>`);
    const costCell = INPLACE
      ? `<input data-id="${r.id}" data-k="cost" value="${escapeHtml(r.cost)}" placeholder="仕入" style="width:100%; padding:6px 8px; border:1px solid #e5e7eb; border-radius:6px;" />`
      : (r.cost ? `<span>${escapeHtml(jpYen(r.cost))}</span>` : `<span class="muted">—</span>`);
    const noteCell = r.note ? `<span class="${r.found ? "ok":"warn"}">${escapeHtml(r.note)}</span>` : (r.found ? `<span class="ok">一致</span>` : `<span class="warn">未一致</span>`);
    return `
      <tr class="${rowCls}">
        <td class="idx">${idx + 1}</td>
        <td class="model">${modelCell}</td>
        <td class="num">${listCell}</td>
        <td class="num">${costCell}</td>
        <td>${noteCell}</td>
        <td><button class="btn danger" data-del="${r.id}">削除</button></td>
      </tr>
    `;
  }).join("");
  tbody.innerHTML = rowsHtml;
  addRowBtn.style.display = INPLACE ? "" : "none";
  estimateBtn.textContent = INPLACE ? "決定（見積表示）" : "再編集（見積表示）";
}

/* ========= 10) ロジック ========= */
function buildRowsFromModels(modelList) {
  const pickType = (entry) => {
    if (!entry) return { type:"SP", arr:[] };
    if (entry.variantsByType) {
      for (const t of ["SP","NR","HNR"]) {
        const arr = entry.variantsByType[t];
        if (arr && arr.length) return { type:t, arr };
      }
      return { type:"SP", arr:[] };
    }
    return { type:"SP", arr: entry.variants || [] };
  };
  const out = [];
  modelList.forEach((m, occIdx) => {
    const key = normalizeKey(m);
    const hit = CSV_MAP ? CSV_MAP.get(key) : null;
    const picked = pickType(hit || null);
    const variants = picked.arr.length ? picked.arr.slice(0,2) : [{ listPrice:"", cost:"" }];
    variants.forEach((v, i) => {
      out.push({
        id: `${key}-${occIdx}-${i}`,
        model: (hit?.model ?? stripParen(m)),
        modelLabel: "", // 初回は空 → 型式のみ表示
        listPrice: v.listPrice,
        cost: v.cost,
        found: !!hit && picked.arr.length > 0,
        note: (!!hit && picked.arr.length > 0) ? `一致（${picked.type})` : "未一致",
        variantIndex: i,
        selectedType: picked.type,
      });
    });
  });
  return out;
}

function resolvePricesFromCsv(prevRows) {
  if (!CSV_MAP) return prevRows;
  const pickType = (entry) => {
    if (!entry) return { type:"SP", arr:[] };
    if (entry.variantsByType) {
      for (const t of ["SP","NR","HNR"]) {
        const arr = entry.variantsByType[t];
        if (arr && arr.length) return { type:t, arr };
      }
      return { type:"SP", arr:[] };
    }
    return { type:"SP", arr: entry.variants || [] };
  };
  return prevRows.map(r => {
    const key = normalizeKey(r.model || "");
    const hit = key ? CSV_MAP.get(key) : null;
    let type = r.selectedType;
    let arr = [];
    if (hit?.variantsByType) {
      arr = type ? (hit.variantsByType[type] || []) : [];
      if (!arr.length) { const picked = pickType(hit); type = picked.type; arr = picked.arr; }
    } else {
      const picked = pickType(hit || null); type = picked.type; arr = picked.arr;
    }
    if (arr.length) {
      const vi = Number.isInteger(r?.variantIndex) ? r.variantIndex : 0;
      const v = arr[vi] || arr[0];
      return { ...r, listPrice: v.listPrice, cost: v.cost, found:true, note:`一致（${type})`, selectedType:type };
    }
    return { ...r, found:false, note:"未一致", selectedType:type || r.selectedType };
  });
}

/* ========= 11) イベント ========= */
// CSV
const onCsvFile = async (f) => {
  if (!f || !f.name?.toLowerCase().endsWith(".csv")) return Toast("CSVファイルを選択してください","error");
  try {
    const { map, meta } = await parseCsvToMap(f);
    CSV_MAP = map;
    document.getElementById("csvMeta").textContent = `${f.name} / 有効行: ${meta.kept} / 一意型式: ${meta.uniqueKeys}件`;
    ROWS = resolvePricesFromCsv(ROWS);
    renderRows();
    Toast("価格マスタを読み込みました");
  } catch (e) {
    console.error(e);
    Toast("CSVの読み込みに失敗しました","error");
  }
};

csvDz.addEventListener("click", ()=> csvInput.click());
csvDz.addEventListener("dragover", e => e.preventDefault());
csvDz.addEventListener("drop", async (e) => {
  e.preventDefault();
  const f = e.dataTransfer.files?.[0];
  onCsvFile(f);
});
csvInput.addEventListener("change", async (e) => {
  const f = e.target.files?.[0];
  onCsvFile(f);
});

// PDF
const onPdfFile = async (f) => {
  if (!f || !(f.type === "application/pdf" || f.name?.toLowerCase().endsWith(".pdf"))) return Toast("PDFファイルを選択してください","error");
  document.getElementById("pdfHint").textContent = "抽出中...";
  try {
    const text = await extractTextFromPdf(f);
    if (!text) Toast("画像ベースのため表示エラー", "error");
    PDF_TEXT = text || "";
    document.getElementById("pdfHint").textContent = PDF_TEXT ? (PDF_TEXT.slice(0,80) + "...") : "";
    if (PDF_TEXT) {
      const models = parseModelList(PDF_TEXT);
      ROWS = buildRowsFromModels(models);
      INPLACE = true; // 編集モード
      renderRows();
      Toast("PDFを優先して見積表を更新しました（型式のみ表示 → 後で品名付与）");
      document.getElementById("estimateBtn").textContent = "決定（見積表示）";
      document.getElementById("addRowBtn").style.display = "";
    }
  } catch (e) {
    console.error(e);
    Toast("PDF抽出に失敗しました","error");
    document.getElementById("pdfHint").textContent = "";
  }
};

pdfDz.addEventListener("click", ()=> pdfInput.click());
pdfDz.addEventListener("dragover", e => e.preventDefault());
pdfDz.addEventListener("drop", async (e) => {
  e.preventDefault();
  const f = e.dataTransfer.files?.[0];
  onPdfFile(f);
});
pdfInput.addEventListener("change", async (e) => {
  const f = e.target.files?.[0];
  onPdfFile(f);
});

// 行追加・削除・編集
document.getElementById("addRowBtn").addEventListener("click", () => {
  ROWS.push({
    id: `ROW-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,
    model:"", modelLabel:"", listPrice:"", cost:"",
    found:false, note:"手入力", variantIndex:0, selectedType:undefined
  });
  renderRows();
});

document.getElementById("tbody").addEventListener("click", (e) => {
  const delId = e.target.getAttribute?.("data-del");
  if (delId) {
    ROWS = ROWS.filter(r => r.id !== delId);
    renderRows();
  }
});
document.getElementById("tbody").addEventListener("input", (e) => {
  const id = e.target.getAttribute?.("data-id");
  const k = e.target.getAttribute?.("data-k");
  if (!id || !k) return;
  const v = e.target.value;
  ROWS = ROWS.map(r => {
    if (r.id !== id) return r;
    let nextVal = v;
    if (k === "listPrice" || k === "cost") nextVal = String(v).replace(/^[^0-9-]+/, "");
    return { ...r, [k]: nextVal };
  });
});

// 見積表示（編集終了 → 品名：型式を付与）
document.getElementById("estimateBtn").addEventListener("click", () => {
  if (INPLACE) {
    ROWS = resolvePricesFromCsv(ROWS).map(r => ({ ...r, modelLabel: labelFromPdfText(r.model || "", PDF_TEXT) }));
    INPLACE = false;
    renderRows();
    Toast("編集を確定し、品名：型式で表示しました");
    document.getElementById("estimateBtn").textContent = "再編集（見積表示）";
    document.getElementById("addRowBtn").style.display = "none";
    return;
  }
  if (ROWS.length > 0) {
    INPLACE = true;
    renderRows();
    Toast("直接編集モードに切替（表示は型式のみになります）");
    document.getElementById("estimateBtn").textContent = "決定（見積表示）";
    document.getElementById("addRowBtn").style.display = "";
    return;
  }
  if (!CSV_MAP) { Toast("CSV マスタ未読込です","error"); return; }
  if (!PDF_TEXT) { Toast("PDFから型式を抽出してください","error"); return; }
  ROWS = buildRowsFromModels(parseModelList(PDF_TEXT));
  INPLACE = true;
  renderRows();
  Toast("PDF結果を読み込み、直接編集モードに切替");
  document.getElementById("estimateBtn").textContent = "決定（見積表示）";
  document.getElementById("addRowBtn").style.display = "";
});

// 列コピー（常に「品名：型式」でコピー。見つからなければ型式のみ）
document.getElementById("grid").addEventListener("click", async (e) => {
  const col = e.target.getAttribute?.("data-copycol");
  if (!col) return;
  const ci = Number(col);
  const pick = (r) => {
    if (ci === 1) {
      const label = r.modelLabel && !INPLACE ? r.modelLabel : labelFromPdfText(r.model || "", PDF_TEXT);
      return String(label || r.model || "");
    }
    if (ci === 2) return r.listPrice ? jpYen(r.listPrice) : "";
    if (ci === 3) return r.cost ? jpYen(r.cost) : "";
    return "";
  };
  const text = ROWS.map(pick).join("\r\n");
  if (!text) { Toast("列に有効な値がありません"); return; }
  try {
    const ok = await tryWriteClipboard(text);
    if (ok) { Toast("コピーしました"); return; }
    throw new Error("clipboard blocked");
  } catch {
    const title = (ci===1?"型式":ci===2?"定価":ci===3?"仕入":"列") + " 列のコピー用テキスト";
    Toast("クリップボードに直接コピーできませんでした（ブラウザの制限）","error");
    openDialog(title, text);
  }
});

// Dialog close
document.getElementById("dlgClose").addEventListener("click", closeDialog);
document.getElementById("dlgMask").addEventListener("click", (e)=> { if (e.target === document.getElementById("dlgMask")) closeDialog(); });
</script>
</body>
</html>
