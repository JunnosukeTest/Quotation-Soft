<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>価格表示ツール（PDF→型式→NR/SP/HNR表示・コピー対応）</title>
<style>
  :root{--brand:#0a6}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Meiryo,sans-serif;background:#f7faf9;margin:0}
  header{background:#fff;border-bottom:1px solid #e4efe9;padding:12px 16px}
  h1{font-size:16px;margin:0}
  main{max-width:1200px;margin:0 auto;padding:16px;display:grid;gap:16px}
  .card{background:#fff;border:1px solid #e4efe9;border-radius:12px;overflow:hidden}
  .card h2{margin:0;padding:10px 12px;background:#f3fbf7;border-bottom:1px solid #e8f2ee;font-size:14px}
  .card .body{padding:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{background:var(--brand);color:#fff;border:0;padding:9px 12px;border-radius:8px;font-weight:700;cursor:pointer}
  .btn:disabled{background:#9acfbf;cursor:not-allowed}
  .ghost{background:#eef5f2;color:#234;border:0;padding:8px 10px;border-radius:8px}
  input[type=file]{padding:6px 8px;border:1px solid #dce7e2;border-radius:8px;background:#fff}
  .drop{border:2px dashed #9dd8c9;border-radius:10px;padding:20px;text-align:center;cursor:pointer;background:#fff}
  .drop.drag{background:#eefaf6;border-color:var(--brand)}
  .muted{font-size:12px;opacity:.8}
  table{width:100%;border-collapse:collapse}
  th,td{padding:6px 8px;border-bottom:1px solid #eef4f1;vertical-align:middle}
  thead th{background:#f5fbf9;position:sticky;top:0;z-index:1}
  .right{text-align:right}
  .editable{width:100%;border:1px solid #dce7e2;border-radius:8px;padding:6px 8px}
  select{border:1px solid #dce7e2;border-radius:8px;padding:6px 8px}
  .ok{color:#0a6;font-weight:700}
  .warn{color:#c00;font-weight:700}
  .copy-btn{margin-left:8px;border:1px solid #dbe6e1;background:#fff;border-radius:6px;cursor:pointer;padding:4px 6px;font-size:12px}
  .copy-btn.copied{background:#e6fbef;border-color:#a7e2c5;color:#086}
  .cell-flex{display:flex;align-items:center;gap:6px}
  .cell-flex.end{justify-content:flex-end}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Roboto Mono", monospace}
</style>
</head>
<body>
<header><h1>価格表示ツール（PDF→型式→NR/SP/HNR表示・コピー対応）</h1></header>
<main>
  <!-- Step 1: 価格マスタの読込 -->
  <div class="card">
    <h2>① 価格マスタ（Excel/CSV）</h2>
    <div class="body">
      <div class="row">
        <input id="masterInput" type="file" accept=".xlsx,.xls,.csv" />
        <span id="masterStatus" class="muted">未読込</span>
        <button id="downloadSample" class="ghost">サンプルCSV</button>
      </div>
      <div class="muted" style="margin-top:6px">
        列名は自動認識します：<b>型式/品番</b>、<b>NR</b>、<b>SP</b>、<b>HNR</b>（あれば）。<br>
        既存の<b>定価/上代</b>→NR扱い、<b>仕入/仕切/原価</b>→SP扱いとしても取り込みます。
      </div>
    </div>
  </div>

  <!-- Step 2: PDF投入→型式抽出＆編集 -->
  <div class="card">
    <h2>② PDF（見積）から型式抽出 → 編集</h2>
    <div class="body">
      <div class="row">
        <div id="drop" class="drop">PDFをドロップ / クリックして選択</div>
        <input id="pdfInput" type="file" accept=".pdf,application/pdf" style="display:none">
        <span id="pdfStatus" class="muted">未読込</span>
      </div>
      <div style="margin-top:10px; max-height:360px; overflow:auto; border:1px solid #eef4f1; border-radius:8px">
        <table>
          <thead><tr><th style="width:56px">No</th><th>抽出型式（手修正可）</th></tr></thead>
          <tbody id="modelsTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Step 3: 見積表示（NR/SP/HNR） -->
  <div class="card">
    <h2>③ 見積表示（型式・NR・SP・HNR）</h2>
    <div class="body">
      <div class="row" style="margin-bottom:8px">
        <button id="showBtn" class="btn" disabled>見積表示</button>
        <button id="exportCsv" class="ghost" disabled>CSVエクスポート</button>
        <span id="resultStatus" class="muted">マスタと型式が必要です</span>
      </div>
      <div class="row" style="margin-bottom:8px">
        CSV出力マッピング：
        定価 = 
        <select id="mapList">
          <option value="NR" selected>NR</option>
          <option value="SP">SP</option>
          <option value="HNR">HNR</option>
        </select>
        ／ 仕入 = 
        <select id="mapCost">
          <option value="SP" selected>SP</option>
          <option value="NR">NR</option>
          <option value="HNR">HNR</option>
        </select>
        <span class="muted">（画面表示は常に NR/SP/HNR の3列を出します）</span>
      </div>
      <div style="max-height:460px; overflow:auto; border:1px solid #eef4f1; border-radius:8px">
        <table>
          <thead>
            <tr>
              <th style="width:56px">No</th>
              <th>型式（PDF/編集）</th>
              <th>マスタ型式（候補）</th>
              <th class="right">NR</th>
              <th class="right">SP</th>
              <th class="right">HNR</th>
              <th>状態</th>
            </tr>
          </thead>
          <tbody id="resultTbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<!-- ライブラリ（CDNフォールバック） -->
<script>
async function loadScript(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.defer=true;s.onload=()=>res();s.onerror=()=>rej(new Error('load fail '+src));document.head.appendChild(s);});}
(async()=>{
  const pdfCDN=["https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js","https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"];
  const xlsxCDN=["https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js","https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"];
  let ok=false, used=null;
  for(const u of pdfCDN){try{await loadScript(u); if(window.pdfjsLib){used=u; ok=true;break}}catch{}}
  for(const u of xlsxCDN){try{await loadScript(u); if(window.XLSX)break}catch{}}
  if(!ok||!window.XLSX){alert("ライブラリ読込失敗"); return}
  try{pdfjsLib.GlobalWorkerOptions.workerSrc=used.replace(/pdf\.min\.js$/,"pdf.worker.min.js")}catch{}
})();
</script>

<script>
/* ========= 状態 ========= */
const state={
  masterRows:[],          // {model, NR, SP, HNR}
  masterIndex:new Map(),  // norm(model)->row
  modelInputs:[],         // HTMLInputElement[]
  matches:[]              // 表示用
};

/* ========= 要素 ========= */
const masterInput=document.getElementById('masterInput');
const masterStatus=document.getElementById('masterStatus');
const downloadSample=document.getElementById('downloadSample');

const pdfInput=document.getElementById('pdfInput');
const drop=document.getElementById('drop');
const pdfStatus=document.getElementById('pdfStatus');

const modelsTbody=document.getElementById('modelsTbody');

const showBtn=document.getElementById('showBtn');
const exportCsv=document.getElementById('exportCsv');
const resultStatus=document.getElementById('resultStatus');
const resultTbody=document.getElementById('resultTbody');

const mapList=document.getElementById('mapList');
const mapCost=document.getElementById('mapCost');

/* ========= 共通 ========= */
function toHalfWidth(s){return String(s).replace(/[！-～]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0)).replace(/　/g,' ')}
function normModel(s){
  if(!s) return "";
  let x=toHalfWidth(String(s)).toUpperCase().trim();
  x=x.replace(/[\s\-_/]/g,''); // 余白・記号を除去
  x=x.replace(/O/g,'0').replace(/[IL]/g,'1'); // ゆらぎ
  return x;
}
function yen(n){ return (n==null||n==="")? "" : Number(n).toLocaleString('ja-JP') }
function toH(s){return String(s??"").replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m]))}
async function copyText(text, btn){
  try{
    if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(text); }
    else{ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }
    if(btn){ btn.classList.add('copied'); const old=btn.textContent; btn.textContent='Copied!'; setTimeout(()=>{btn.classList.remove('copied'); btn.textContent=old;}, 1500); }
  }catch(e){ if(btn){ btn.textContent='コピー失敗'; btn.disabled=true; } console.error(e); }
}
function makeCopyBtn(getter,label="コピー"){
  const b=document.createElement('button'); b.className='copy-btn'; b.type='button'; b.textContent=label;
  b.addEventListener('click',()=> copyText(getter(), b));
  return b;
}

/* ========= サンプルCSV（NR/SP/HNR列あり） ========= */
downloadSample.addEventListener('click', ()=>{
  const csv = "型式,NR,SP,HNR\nMFC-S008,200000,187000,195000\nMFC-DP01,20000,16000,18000\nDPM-011H1-15F,650000,598000,620000\nC30-FH1-M5,80000,70000,76000\nDSP-UC-N,25000,20000,23000\n";
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"})); a.download="価格マスタ_サンプル_NR_SP_HNR.csv"; a.click();
});

/* ========= 価格マスタ読込（NR/SP/HNR対応） ========= */
masterInput.addEventListener('change', async ()=>{
  const f=masterInput.files?.[0]; if(!f){ masterStatus.textContent="未読込"; return; }
  try{
    masterStatus.textContent="読込中…";
    const buf=await f.arrayBuffer();
    let rows=[];
    if(/\.csv$/i.test(f.name)){
      const txt=new TextDecoder('utf-8').decode(buf);
      const lines=txt.split(/\r?\n/).filter(l=>l.trim().length>0);
      const header=lines[0].split(',').map(h=>h.trim());
      rows = lines.slice(1).map(l=>{
        const cells=l.split(',');
        const obj={}; header.forEach((h,i)=> obj[h]=cells[i]??"");
        return obj;
      });
    }else{
      const wb=XLSX.read(buf,{type:'array'}); const sh=wb.Sheets[wb.SheetNames[0]];
      rows=XLSX.utils.sheet_to_json(sh,{defval:""});
    }
    if(!rows.length){ throw new Error("データ行がありません"); }

    // 列推定（全角NR/SP/HNRも吸収）
    const pick=(names)=> Object.keys(rows[0]||{}).find(h=> names.some(n=> new RegExp(n,'i').test(String(h).replace(/[！-～]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0)))));
    const modelCol = pick(["型式","品番","型番","Model","Part"]);
    const nrCol    = pick(["NR","定価","上代","標準価格","List"]);
    const spCol    = pick(["SP","仕入","仕切","原価","Cost","買価格"]);
    const hnrCol   = pick(["HNR"]);

    if(!modelCol) throw new Error("型式列が見つかりません（例：型式/品番）");

    state.masterRows = rows.map(r=>{
      const parseN = (v)=> Number(String(v??"").replace(/[^\d.-]/g,''))||0;
      return {
        model: String(r[modelCol]||"").trim(),
        NR:  nrCol  ? parseN(r[nrCol])  : 0,
        SP:  spCol  ? parseN(r[spCol])  : 0,
        HNR: hnrCol ? parseN(r[hnrCol]) : 0
      };
    }).filter(r=>r.model);

    // インデックス
    state.masterIndex.clear();
    for(const r of state.masterRows){ state.masterIndex.set(normModel(r.model), r); }

    masterStatus.textContent = `読込OK：${state.masterRows.length}件（列: ${nrCol?'NR':''}${spCol?'/SP':''}${hnrCol?'/HNR':''})`;
    updateShowButtonState();
  }catch(e){
    console.error(e);
    masterStatus.textContent="読込失敗: "+e.message;
  }
});

/* ========= PDF → 型式抽出 & 編集 ========= */
['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.add('drag')}));
['dragleave','drop'].forEach(ev=> drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.remove('drag')}));
drop.addEventListener('click',()=> pdfInput.click());
drop.addEventListener('drop', e=>{
  e.preventDefault(); drop.classList.remove('drag');
  const f=[...e.dataTransfer.files].find(f=>/\.pdf$/i.test(f.name)); if(f) loadPdf(f);
});
pdfInput.addEventListener('change', ()=>{ const f=pdfInput.files?.[0]; if(f) loadPdf(f); });

async function loadPdf(f){
  if(!window.pdfjsLib){ alert("pdf.js 未ロード"); return; }
  pdfStatus.textContent="読込中…";
  try{
    const buf=await f.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data:buf}).promise;

    // テキスト行を上→下で再構成
    let lines=[];
    for(let p=1;p<=pdf.numPages;p++){
      const page=await pdf.getPage(p);
      const c=await page.getTextContent();
      lines=lines.concat(rebuildLines(c.items));
    }

    // 型式候補抽出（英数＋-_/ を含む3文字以上のトークン）
    const models = extractModels(lines);
    renderModelInputs(models);

    pdfStatus.textContent=`抽出: ${models.length} 件`;
    updateShowButtonState();
  }catch(e){
    console.error(e);
    pdfStatus.textContent="読込失敗: "+e.message;
  }
}

function rebuildLines(items){
  const tol=2, pts=items.map(it=>({x:it.transform[4],y:it.transform[5],s: toHalfWidth(it.str)}));
  // y降順→x昇順で並べて行にまとめ、最後に反転して上→下へ
  pts.sort((a,b)=> (Math.abs(b.y-a.y)>tol?b.y-a.y:a.x-b.x));
  let curY=null,buf=[],rows=[];
  for(const p of pts){
    if(curY===null||Math.abs(p.y-curY)<=tol){curY=curY??p.y;buf.push(p)}
    else{
      buf.sort((a,b)=>a.x-b.x);
      const joined=buf.map(x=>x.s).join(' ').replace(/\s{2,}/g,' ').trim();
      rows.push(joined);
      curY=p.y;buf=[p];
    }
  }
  if(buf.length){ buf.sort((a,b)=>a.x-b.x); rows.push(buf.map(x=>x.s).join(' ').replace(/\s{2,}/g,' ').trim()); }
  rows.reverse();
  return rows.filter(Boolean);
}
function extractModels(lines){
  const set=new Set();
  const re=/[A-Za-z0-9][A-Za-z0-9\-_/]*[A-Za-z0-9]/g;
  const ban=/^(FAX|TEL|DATE|QTY|PCS|PDF|NO|JAN|CODE|MODEL)$/i;
  for(const line of lines){
    const s=toHalfWidth(line);
    const toks = s.match(re) || [];
    for(const t of toks){
      if(t.length<3) continue;
      if(ban.test(t)) continue;
      set.add(t);
    }
  }
  return [...set];
}
function renderModelInputs(models){
  modelsTbody.innerHTML='';
  state.modelInputs = models.map((m,i)=>{
    const tr=document.createElement('tr');
    const tdNo=document.createElement('td'); tdNo.textContent=String(i+1);
    const tdIn=document.createElement('td');
    const inp=document.createElement('input'); inp.className='editable mono'; inp.value=m;
    inp.addEventListener('input', updateShowButtonState);
    tdIn.appendChild(inp);
    tr.appendChild(tdNo); tr.appendChild(tdIn);
    modelsTbody.appendChild(tr);
    return inp;
  });
}

/* ========= 見積表示（NR/SP/HNRを表示＋コピー） ========= */
function updateShowButtonState(){
  const okMaster = state.masterRows.length>0;
  const okModels = state.modelInputs.length>0;
  showBtn.disabled = !(okMaster && okModels);
  exportCsv.disabled = true;
  resultStatus.textContent = showBtn.disabled ? "マスタと型式が必要です" : "見積表示を押してください";
}
showBtn.addEventListener('click', ()=>{
  const models = state.modelInputs.map((inp,i)=>({idx:i+1, pdfModel: inp.value.trim()})).filter(x=>x.pdfModel);
  const rows=[];
  for(const it of models){
    const key=normModel(it.pdfModel);
    const row = state.masterIndex.get(key);
    rows.push({
      idx: it.idx,
      pdfModel: it.pdfModel,
      masterModel: row?.model || "",
      NR: row?.NR || 0,
      SP: row?.SP || 0,
      HNR: row?.HNR || 0,
      ok: !!row
    });
  }
  state.matches = rows;
  renderResults(rows);
});
function renderResults(rows){
  resultTbody.innerHTML='';
  if(!rows.length){ resultStatus.textContent="型式がありません"; return; }
  resultStatus.textContent = "結果を表示しました。未一致は候補から選択してください。";
  // 候補（先頭200件）
  const masterOptions = state.masterRows.slice(0, 200).map(r=>r.model);

  rows.forEach((r)=>{
    const tr=document.createElement('tr');

    // 型式（表示+コピー）
    const tdPdf=document.createElement('td');
    const pdfSpan=document.createElement('span'); pdfSpan.textContent=r.pdfModel; pdfSpan.className='mono';
    const btnCopyPdf = makeCopyBtn(()=> r.pdfModel, "コピー");
    const wrapPdf=document.createElement('div'); wrapPdf.className='cell-flex'; wrapPdf.append(pdfSpan, btnCopyPdf);

    // マスタ型式の候補セレクト
    const tdSel=document.createElement('td');
    const sel=document.createElement('select');
    const defaultOpt=document.createElement('option');
    defaultOpt.value=""; defaultOpt.textContent = r.masterModel ? r.masterModel : "（候補を選択）";
    sel.appendChild(defaultOpt);
    masterOptions.forEach(m=>{
      const o=document.createElement('option'); o.value=m; o.textContent=m; sel.appendChild(o);
    });
    sel.addEventListener('change', ()=>{
      const model=sel.value;
      if(!model) return;
      const row = state.masterRows.find(x=>x.model===model);
      if(row){
        r.masterModel=row.model; r.NR=row.NR; r.SP=row.SP; r.HNR=row.HNR; r.ok=true;
        renderResults(state.matches); // 再描画
      }
    });
    tdSel.appendChild(sel);

    // 各価格（表示+コピー）
    const tdNR=document.createElement('td'); tdNR.className='right';
    const nrStr = r.NR ? r.NR.toLocaleString('ja-JP') : "";
    const wrapNR=document.createElement('div'); wrapNR.className='cell-flex end';
    wrapNR.append(Object.assign(document.createElement('span'),{textContent:nrStr,className:'mono'}), makeCopyBtn(()=> nrStr));
    tdNR.appendChild(wrapNR);

    const tdSP=document.createElement('td'); tdSP.className='right';
    const spStr = r.SP ? r.SP.toLocaleString('ja-JP') : "";
    const wrapSP=document.createElement('div'); wrapSP.className='cell-flex end';
    wrapSP.append(Object.assign(document.createElement('span'),{textContent:spStr,className:'mono'}), makeCopyBtn(()=> spStr));
    tdSP.appendChild(wrapSP);

    const tdHNR=document.createElement('td'); tdHNR.className='right';
    const hnrStr = r.HNR ? r.HNR.toLocaleString('ja-JP') : "";
    const wrapHNR=document.createElement('div'); wrapHNR.className='cell-flex end';
    wrapHNR.append(Object.assign(document.createElement('span'),{textContent:hnrStr,className:'mono'}), makeCopyBtn(()=> hnrStr));
    tdHNR.appendChild(wrapHNR);

    // 状態
    const tdState=document.createElement('td'); tdState.innerHTML = r.ok?'<span class="ok">一致</span>':'<span class="warn">未一致</span>';

    tr.appendChild(Object.assign(document.createElement('td'),{textContent:String(r.idx)}));
    tr.appendChild(tdPdf);
    tr.appendChild(tdSel);
    tr.appendChild(tdNR);
    tr.appendChild(tdSP);
    tr.appendChild(tdHNR);
    tr.appendChild(tdState);
    tr.children[1].appendChild(wrapPdf);

    resultTbody.appendChild(tr);
  });
  exportCsv.disabled=false;
}

/* ========= CSV出力（マッピング選択に従う / 併せてNR,SP,HNRも出力） ========= */
exportCsv.addEventListener('click', ()=>{
  const mapL = mapList.value; // 定価に使う列
  const mapC = mapCost.value; // 仕入に使う列
  const header=["No","型式(PDF/編集)","マスタ型式","NR","SP","HNR","定価("+mapL+")","仕入("+mapC+")"];
  const lines=[header.join(",")];
  state.matches.forEach(r=>{
    const list = (r[mapL]??0);
    const cost = (r[mapC]??0);
    lines.push([
      r.idx,
      `"${r.pdfModel}"`,
      `"${r.masterModel}"`,
      r.NR, r.SP, r.HNR,
      list, cost
    ].join(","));
  });
  const blob=new Blob([lines.join("\n")],{type:"text/csv"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="価格表示_NR_SP_HNR.csv"; a.click();
});
</script>
</body>
</html>
