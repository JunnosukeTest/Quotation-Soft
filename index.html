<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PDF → Excel（“明細/Raw/見積書取込(国内)_レイアウト (2)” 出力）</title>
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Meiryo,sans-serif;background:#f6fbf9;margin:0}
  header{padding:14px 18px;border-bottom:1px solid #dde7e3;background:#fff}
  h1{margin:0;font-size:16px}
  main{max-width:960px;margin:0 auto;padding:16px}
  .drop{border:2px dashed #9dd8c9;border-radius:12px;background:#fff;padding:28px;text-align:center;cursor:pointer}
  .drop.drag{background:#f0faf7;border-color:#0a6}
  .row{margin:14px 0;display:flex;align-items:center;gap:12px}
  .btn{background:#0a6;color:#fff;border:0;padding:10px 14px;border-radius:8px;font-weight:700;cursor:pointer}
  .btn:disabled{background:#9acfbf;cursor:not-allowed}
  .hint{font-size:12px;opacity:.85}
  .tbl{overflow:auto;max-height:420px;border:1px solid #dde7e3;border-radius:8px;background:#fff}
  table{width:100%;border-collapse:collapse}
  th,td{padding:6px 8px;border-bottom:1px solid #eef4f1}
  thead th{background:#f5fbf9;position:sticky;top:0}
  .right{text-align:right}
  input[type=text],input[type=number]{width:100%;border:1px solid #dde7e3;border-radius:6px;padding:4px 6px}
</style>
</head>
<body>
<header><h1>PDF → Excel（“明細/Raw/見積書取込(国内)_レイアウト (2)” 出力）</h1></header>
<main>
  <div id="drop" class="drop">ここに PDF をドロップ<br><span class="hint">クリックでも選択可（.pdf）</span></div>
  <input id="pdfInput" type="file" accept=".pdf,application/pdf" style="display:none;">
  <div class="row">
    <button id="exportBtn" class="btn" disabled>Excel出力</button>
    <span id="status" class="hint">PDFを選択してください</span>
  </div>

  <div class="tbl">
    <table>
      <thead><tr>
        <th>品名</th><th>型式</th><th class="right">数量</th><th>単位</th><th class="right">単価</th><th class="right">金額</th>
      </tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</main>

<script>
// ===== ライブラリ読込（CDNフォールバック） =====
async function loadScript(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.defer=true;s.onload=()=>res(true);s.onerror=()=>rej(new Error('load fail: '+src));document.head.appendChild(s);});}
async function ensureLibs(){
  const pdfCDNs=["https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js","https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"];
  const xlsxCDNs=["https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js","https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"];
  let used=null; for(const u of pdfCDNs){try{await loadScript(u);if(window.pdfjsLib){used=u;break}}catch{}}
  for(const u of xlsxCDNs){try{await loadScript(u);if(window.XLSX)break}catch{}}
  if(!window.pdfjsLib) throw new Error("pdf.js 読込失敗"); if(!window.XLSX) throw new Error("xlsx 読込失敗");
  try{pdfjsLib.GlobalWorkerOptions.workerSrc=used.replace(/pdf\.min\.js$/,"pdf.worker.min.js")}catch{}
}
const statusEl=document.getElementById('status'), exportBtn=document.getElementById('exportBtn');
const drop=document.getElementById('drop'), pdfInput=document.getElementById('pdfInput'), tbody=document.getElementById('tbody');
let currentFile=null, lastLines=[];

(async()=>{try{statusEl.textContent="ライブラリ読込中…";await ensureLibs();statusEl.textContent="準備OK：PDFを選択してください"}catch(e){statusEl.textContent="初期化失敗: "+e.message}})();

// ===== D&D =====
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();drop.classList.add('drag')}));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();drop.classList.remove('drag')}));
drop.addEventListener('drop',e=>{e.preventDefault();e.stopPropagation();const f=[...e.dataTransfer.files].find(f=>/\.pdf$/i.test(f.name)); if(!f){statusEl.textContent="PDFではありません";return} handleFile(f)});
drop.addEventListener('click',()=>pdfInput.click());
pdfInput.addEventListener('change',()=>{const f=pdfInput.files?.[0]; if(!f){statusEl.textContent="未選択";return} if(!/\.pdf$/i.test(f.name)){statusEl.textContent="PDFを選択してください";return} handleFile(f)});

// ===== 共通ユーティリティ =====
function toHalfWidth(s){return String(s).replace(/[！-～]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0)).replace(/　/g,' ')}
function normalizeNumberGaps(s){s=s.replace(/\s+/g,' ').trim();for(let i=0;i<4;i++)s=s.replace(/(\d)\s*,\s*(\d{3})(?!\d)/g,'$1,$2');s=s.replace(/([¥￥])\s+/g,'$1');return s}
function normLine(s){return normalizeNumberGaps(toHalfWidth(s||""))}
function toInt(s){if(!s)return 0; s=normLine(String(s)).replace(/[¥￥,\s]/g,''); const n=Number(s); return isNaN(n)?0:n}
function parseQtyToken(tok){const m=normLine(String(tok||'')).match(/^(\d+)\s*(式|個|台|本)?$/); if(m) return {qty:Number(m[1]), qUnit:m[2]||""}; const n=toInt(tok); return {qty:n||0,qUnit:""}}
function rebuildLines(items){
  const tol=2, pts=items.map(it=>({x:it.transform[4],y:it.transform[5],s: toHalfWidth(it.str)}));
  pts.sort((a,b)=> (Math.abs(b.y-a.y)>tol?b.y-a.y:a.x-b.x));
  let curY=null,buf=[],rows=[];
  for(const p of pts){
    if(curY===null||Math.abs(p.y-curY)<=tol){curY=curY??p.y;buf.push(p)}
    else{buf.sort((a,b)=>a.x-b.x);rows.push(normalizeNumberGaps(buf.map(x=>x.s).join(' ').replace(/\s{2,}/g,' ').trim()));curY=p.y;buf=[p]}
  }
  if(buf.length){buf.sort((a,b)=>a.x-b.x);rows.push(normalizeNumberGaps(buf.map(x=>x.s).join(' ').replace(/\s{2,}/g,' ').trim()))}
  rows.reverse(); return rows.filter(Boolean)
}
function addRow(it){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td><input type="text" value="${it.name||''}"></td>
  <td><input type="text" value="${it.model||''}"></td>
  <td class="right"><input type="number" value="${it.qty||0}"></td>
  <td><input type="text" value="${it.qUnit||''}"></td>
  <td class="right"><input type="number" value="${it.unit||0}"></td>
  <td class="right"><input type="number" value="${it.amount||0}"></td>`;
  tbody.appendChild(tr);
}
function ensureAtLeastOneRow(){ if(!tbody.querySelector('tr')) addRow({name:"",model:"",qty:0,qUnit:"",unit:0,amount:0})}

// ===== 抽出ロジック（実働） =====
function pickPricesFromLine(s){const nums=[];const re=/[¥￥]?\s*\-?\d{1,3}(?:,\d{3})*(?:\.\d+)?/g;let m;while((m=re.exec(s))) nums.push(toInt(m[0])); const f=nums.filter(n=>n!==0); if(f.length>=2) return {unit:f[f.length-2],amount:f[f.length-1]}; if(f.length===1) return {unit:f[0],amount:f[0]}; return {unit:0,amount:0}}
function splitNameModel(desc){const s=normLine(desc||""); const toks=s.split(' '); const looks=(t)=>/[A-Za-z]/.test(t)&&/[0-9A-Za-z\-]/.test(t); if(toks.length>=2&&looks(toks[toks.length-1])) return [toks.slice(0,-1).join(' '),toks[toks.length-1]]; const m=s.match(/^([A-Za-z0-9][A-Za-z0-9\-]+)\s*(.+)$/); if(m) return [m[2],m[1]]; return [s,""]}
function parseItems(lines){
  const rows=lines.map((raw,i)=>({i,s:normLine(raw||"")}));
  const labeled=/^\s*(\d+)\s*\(品名\)\s*(.+?)\s*\(型式\)\s*([^\s]+)\s*\(数量\)\s*(\d+)\s*([^\s]+)\s*\(仕切\)\s*([¥￥]?\s*\-?\d{1,3}(?:,\d{3})*(?:\.\d+)?)\s*(?:\((?:金額)?\)\s*([¥￥]?\s*\-?\d{1,3}(?:,\d{3})*(?:\.\d+)?)\s*)?$/;
  const num=/^(\d+)\s+(\d+(?:\s*(?:式|個|台|本))?)\b.*$/;
  const lump=/^(\d+)\s*([¥￥]?\s*\-?\d{1,3}(?:,\d{3})*(?:\.\d+)?)(.*)$/;
  const skip=/^(合\s*計|小\s*計|税|備考|納\s*期|有\s*効|お\s*支\s*払|御\s*見\s*積|見\s*積\s*書|項\s*目|品\s*名|型\s*式)/;

  const kinds=rows.map(r=>{
    if(labeled.test(r.s)) return {...r,kind:'labeled'};
    if(num.test(r.s))     return {...r,kind:'num'};
    if(lump.test(r.s))    return {...r,kind:'lump'};
    if(skip.test(r.s))    return {...r,kind:'skip'};
    return {...r,kind:'desc'};
  });

  const items=[];
  for(const r of kinds){
    if(r.kind!=='labeled') continue;
    const m=r.s.match(labeled);
    const idx=Number(m[1]), name=m[2].trim(), model=m[3].trim(), qty=Number(m[4])||0, qUnit=(m[5]||"").trim();
    const unit=toInt(m[6]); const amtRaw=m[7]; const amount=amtRaw?toInt(amtRaw):(qty*unit);
    items.push({idx,name,model,qty,qUnit,unit,amount,isLump:false});
  }

  const used=new Set();
  function nearestDesc(pos){
    const N=kinds.length;
    for(let r=1;r<=8;r++){
      const L=pos-r,R=pos+r;
      if(L>=0 && kinds[L].kind==='desc' && !used.has(L)){used.add(L);return kinds[L].s}
      if(R<N && kinds[R].kind==='desc' && !used.has(R)){used.add(R);return kinds[R].s}
    }
    return "";
  }

  for(const r of kinds){
    if(r.kind!=='num') continue;
    const idxNum=Number(r.s.match(num)[1]);
    if(items.find(it=>it.idx===idxNum)) continue;
    const m=r.s.match(num);
    const idx=Number(m[1]); const {qty,qUnit}=parseQtyToken(m[2]);
    const {unit,amount}=pickPricesFromLine(r.s);
    const desc=nearestDesc(r.i); const [name,model]=splitNameModel(desc);
    items.push({idx,name,model,qty,qUnit,unit,amount:(amount||qty*unit),isLump:false});
  }

  for(const r of kinds){
    if(r.kind!=='lump') continue;
    const m=r.s.match(lump); const idx=Number(m[1]);
    if(items.find(it=>it.idx===idx)) continue;
    const amt=toInt(m[2]); const desc=normLine(m[3]||""); if(!desc) continue;
    const [name,model]=splitNameModel(desc);
    items.push({idx,name,model,qty:1,qUnit:"式",unit:0,amount:amt,isLump:true});
  }
  items.sort((a,b)=>a.idx-b.idx);
  return items;
}

// ===== ファイル処理 =====
async function handleFile(f){
  currentFile=f; exportBtn.disabled=false; tbody.innerHTML=''; ensureAtLeastOneRow();
  statusEl.textContent=`読み込み中: ${f.name}`;
  try{
    const buf=await f.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data:buf}).promise;
    let lines=[]; for(let p=1;p<=pdf.numPages;p++){ const page=await pdf.getPage(p); const c=await page.getTextContent(); lines=lines.concat(rebuildLines(c.items)) }
    lastLines=lines.slice();
    const items=parseItems(lines);
    if(items.length>0){ tbody.innerHTML=''; items.forEach(addRow) }
    statusEl.textContent=`解析完了: ${items.length} 行`;
  }catch(e){ console.error(e); statusEl.textContent="解析失敗: "+(e.message||e) } finally { exportBtn.disabled=false; ensureAtLeastOneRow() }
}

// ===== Excel出力（明細 / Raw / 見積書取込(国内)_レイアウト (2)） =====
exportBtn.addEventListener('click',()=>{
  try{
    if(!window.XLSX) throw new Error("xlsx.js 未読込");
    // 画面の値（手修正反映）
    const uiItems=[...tbody.querySelectorAll('tr')].map(tr=>{
      const t=tr.querySelectorAll('td input');
      return {name:t[0].value.trim(),model:t[1].value.trim(),qty:Number(t[2].value)||0,qUnit:t[3].value.trim(),unit:(t[4].value===""?"":Number(t[4].value)||0),amount:Number(t[5].value)||0};
    });

    const wb=XLSX.utils.book_new();

    // 1) 明細
    const detailRows=uiItems.map(it=>{const nm=[it.name,it.model].filter(Boolean).join(' '); const unit=(it.unit===""?"":(Number(it.unit)||0)); return [nm,it.qty||0,unit,it.amount||0]});
    const wsDetail=XLSX.utils.aoa_to_sheet([["","","",""],...detailRows]); wsDetail['!cols']=[{wch:40},{wch:8},{wch:12},{wch:12}];
    XLSX.utils.book_append_sheet(wb,wsDetail,"明細");

    // 2) Raw（上→下）
    const rawAoa=[["#","line"],...lastLines.slice().reverse().map((s,i)=>[i+1,s])];
    const wsRaw=XLSX.utils.aoa_to_sheet(rawAoa); wsRaw['!cols']=[{wch:6},{wch:100}];
    XLSX.utils.book_append_sheet(wb,wsRaw,"Raw");

    // 3) 見積書取込(国内)_レイアウト (2)
    const header=Array(22).fill(""); header[1]="品名・仕様"; header[13]="単価"; header[16]="金額"; header[20]="率"; header[21]="買価格";
    const layout=[header];
    uiItems.forEach((it,i)=>{
      const row=Array(22).fill("");
      const nm=[it.name,it.model].filter(Boolean).join(' ');
      const unit=(it.unit===""?"":(Number(it.unit)||0));
      const amount=it.amount||0;
      row[0]=i+1;           // A: 行番号
      row[1]=nm;            // B: 品名・仕様
      row[13]=unit===""?"":unit; // N: 単価（空欄可）
      row[16]=amount;       // Q: 金額
      row[21]=unit===""?amount:unit; // V: 買価格
      layout.push(row);
    });
    const wsLayout=XLSX.utils.aoa_to_sheet(layout);
    wsLayout['!cols']=Array.from({length:22},(_,i)=> i===1?{wch:40} : (i===0?{wch:6} : (i===13||i===16||i===21?{wch:12}:{wch:8})));
    XLSX.utils.book_append_sheet(wb,wsLayout,"見積書取込(国内)_レイアウト (2)");

    const name=(currentFile?.name?.replace(/\.pdf$/i,'')||"converted")+"_同フォーマット.xlsx";
    XLSX.writeFile(wb,name);
    statusEl.textContent="Excel出力 完了: "+name;
  }catch(e){ console.error(e); statusEl.textContent="Excel出力失敗: "+(e.message||e) }
});
</script>
</body>
</html>
