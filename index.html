<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>価格表示ツール（テキストPDF専用 / 縦列コピー対応）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;background:#fff;color:#111;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px}
    h1{margin:0;font-size:20px;color:#065f46;font-weight:800}
    .sub{font-size:12px;color:#047857}
    .card{border:1px solid #a7f3d0;border-radius:12px;margin:16px;overflow:hidden}
    .card h2{margin:0;padding:12px 16px;background:#ecfdf5;color:#065f46;border-bottom:1px solid #e5e7eb;font-size:16px}
    .card-content{padding:16px}
    button{cursor:pointer}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #a7f3d0;background:#fff;color:#047857;font-weight:700}
    .btn.primary{background:#059669;border-color:#059669;color:#fff}
    .btn.danger{border-color:#fecaca;color:#b91c1c}
    .grid-wrap{overflow:auto;border:1px solid #a7f3d0;border-radius:12px}
    table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:14px}
    th,td{border:1px solid #a7f3d0;padding:6px 8px;text-align:left}
    th{background:#ecfdf5;color:#065f46}
    td.idx{width:50px;text-align:right;font-size:12px}
    td.model{white-space:nowrap}
    .muted{color:#9ca3af}
    .ok{color:#047857}
    .warn{color:#9a3412}
    .row-warn{background:#fff7ed}
    .toolbar{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:8px;opacity:0;transform:translateY(8px);transition:all .2s;pointer-events:none;z-index:1000}
    .toast.show{opacity:1;transform:translateY(0)}
    .toast.error{background:#9f1239}
    .dlg-mask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.3);padding:16px;z-index:1000}
    .dlg{width:min(720px,95vw);background:#fff;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .dlg-hd{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #e5e7eb}
    .dlg-tt{font-weight:600;color:#064e3b}
    .dlg-bd{padding:12px}
    .dlg-bd p{margin:0 0 8px;font-size:12px;color:#065f46}
    .dlg-bd textarea{width:100%;height:320px;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-family:ui-monospace,Consolas,Menlo,monospace;font-size:13px}
  </style>
  <!-- pdf.js（安定版 cdnjs） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js"></script>
  <script>
    // workerSrc を必ず明示
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.worker.min.js";
  </script>
  <!-- PapaParse -->
  <script defer src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <header>
    <h1>価格表示ツール（テキストPDF専用・縦列コピー対応）</h1>
    <div class="sub">背景：白 / 基調：ライトグリーン</div>
  </header>

  <div class="card">
    <h2>1. 価格マスタCSVの読み込み</h2>
    <div class="card-content">
      <input type="file" id="csvInput" accept=".csv" />
      <div id="csvMeta" class="sub" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="card">
    <h2>2. 型式の入力（PDF抽出）</h2>
    <div class="card-content">
      <input type="file" id="pdfInput" accept="application/pdf,.pdf" />
      <div id="pdfStatus" class="sub" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="card">
    <h2>3. 見積表（縦列コピーはヘッダの「コピー」ボタン）</h2>
    <div class="card-content">
      <div class="toolbar">
        <button id="addRowBtn" class="btn" style="display:none">行を追加</button>
        <button id="estimateBtn" class="btn primary" style="margin-left:auto">見積表示</button>
      </div>
      <div class="grid-wrap">
        <table id="grid">
          <colgroup>
            <col style="width:50px" />
            <col style="width:52%" />
            <col style="width:12%" />
            <col style="width:12%" />
            <col style="width:16%" />
            <col style="width:80px" />
          </colgroup>
          <thead>
            <tr>
              <th>項目</th>
              <th>型式 <button class="btn" data-copycol="1">コピー</button></th>
              <th>定価 <button class="btn" data-copycol="2">コピー</button></th>
              <th>仕入 <button class="btn" data-copycol="3">コピー</button></th>
              <th>備考</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="6" style="padding:16px;text-align:center;color:#047857">ここに結果が表示されます</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <footer class="sub" style="margin: 0 16px 24px">
    <ul style="margin:0;padding-left:16px">
      <li>CSVは <b>縦持ち: 型式, 定価, 仕入, 種別(SP/NR/HNR)</b> または <b>横持ち: 型式, SP定価, SP仕入, NR定価, NR仕入, HNR定価, HNR仕入</b> に対応（各種別で最大2種類）。</li>
      <li><b>TNHS- / TEL / FAX / DSP3000 / PC / UL / COM</b> は自動除外。型式末尾の <b>( ... )</b> は照合時に無視。</li>
      <li>ひらがな・漢字・カタカナ（全角・半角）を含む型式は対象外。<b>PDFはテキストベースのみ</b>（画像ベースは抽出不可）。</li>
      <li>列コピーはヘッダの「コピー」から。失敗時は手動コピー用ダイアログが開きます。</li>
    </ul>
  </footer>

  <!-- 手動コピー Dialog -->
  <div id="dlgMask" class="dlg-mask" role="dialog" aria-modal="true">
    <div class="dlg">
      <div class="dlg-hd">
        <div id="dlgTitle" class="dlg-tt"></div>
        <button id="dlgClose" class="btn">閉じる</button>
      </div>
      <div class="dlg-bd">
        <p>全選択済みです。Ctrl/Cmd+C でコピーし、Excelの結合セル先頭に貼り付けてください。</p>
        <textarea id="dlgText" readonly></textarea>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ===== Toast ===== */
const Toast = (() => {
  const el = document.getElementById("toast");
  let t = null;
  return (msg, kind="normal") => {
    el.textContent = msg;
    el.classList.remove("error","show");
    if (kind === "error") el.classList.add("error");
    void el.offsetWidth;
    el.classList.add("show");
    clearTimeout(t);
    t = setTimeout(()=> el.classList.remove("show"), 1800);
  };
})();

/* ===== Helpers ===== */
const stripParen = (s) => String(s ?? "").replace(/\([^)]*\)/g,"").trim();
const isNoise = (s) => /^(TNHS-|TEL|FAX|PC|UL|COM)/i.test(String(s).trim()) || /^DSP3000$/i.test(String(s).trim());
const isValidModel = (s) => { const b = stripParen(s); if (!/^[A-Z]/.test(b)) return false; if (/[ぁ-んァ-ヶｦ-ﾟ一-龯々]/.test(b)) return false; return true; };
const normalizeKey = (s) => stripParen(s).toUpperCase().replace(/[-\s]/g,"");
const jpYen = (n) => { const num = parseFloat(String(n ?? "").replace(/[^0-9.-]/g,"")); if (isNaN(num)) return ""; return new Intl.NumberFormat("ja-JP").format(num); };
const parseModelList = (txt) => (txt||"").split(/[\n,;\t\s]+/).map(x=>stripParen(x)).map(x=>x.trim()).filter(x=>x && !isNoise(x) && isValidModel(x));

/** 同一行の左側に日本語があれば「品名：型式」を返す（なければ型式のみ） */
function labelFromPdfText(model, pdfText){
  const m = stripParen(model||""); if (!m) return "";
  const lines = String(pdfText||"").split(/\r?\n+/);
  for (const raw of lines) {
    const line = raw.trim(); if (!line) continue;
    const idx = line.indexOf(m); if (idx === -1) continue;
    const left = line.slice(0, idx).trim();
    if (/[ぁ-んァ-ヶｦ-ﾟ一-龯々]/.test(left)) {
      const name = left.replace(/[:：]+\s*$/,"").replace(/^品名[:：]?\s*/,"").slice(-40).trim();
      if (name) return `${name}：${m}`;
    }
  }
  return m;
}

/* ===== Clipboard ===== */
async function tryWriteClipboard(text){
  try{
    if (navigator?.clipboard && window?.isSecureContext){
      await navigator.clipboard.writeText(text); return true;
    }
  }catch{}
  try{
    const ta=document.createElement("textarea");
    ta.value=text; ta.setAttribute("readonly","");
    ta.style.position="fixed"; ta.style.top="-1000px"; ta.style.left="-1000px";
    document.body.appendChild(ta); ta.focus(); ta.select(); ta.setSelectionRange(0, ta.value.length);
    const ok = document.execCommand && document.execCommand("copy");
    document.body.removeChild(ta);
    if (ok) return true;
  }catch{}
  return false;
}

/* ===== State ===== */
let CSV_MAP = null;   // Map<key, { model, variantsByType: {SP|NR|HNR: Variant[] } }>
let PDF_TEXT = "";
let ROWS = [];        // [{id, model, modelLabel, listPrice, cost, found, note, ...}]
let INPLACE = false;

/* ===== CSV 読込（縦/横両対応・各種別2件まで） ===== */
function parseCsvToMap(file){
  return new Promise((resolve, reject)=>{
    if (!window.Papa || !Papa.parse) return reject(new Error("Papa not loaded"));
    Papa.parse(file, {
      header:false, skipEmptyLines:true, encoding:"UTF-8",
      complete: (res) => {
        const rows = res.data;
        const m = new Map(); let kept=0; const byTypeCount={SP:0,NR:0,HNR:0};
        const ensureEntry = (key, model) => {
          const cur = m.get(key); if (cur) return cur;
          const entry = { model:String(model).trim(), variantsByType:{ SP:[], NR:[], HNR:[] } };
          m.set(key, entry); return entry;
        };
        const isHeaderRow = (cells) => { const c0 = String(cells?.[0] ?? "").toUpperCase(); return ["MODEL","品番","型式"].some(h=>c0.includes(h)); };

        for (const row of rows){
          if (!row || row.length===0) continue;
          if (isHeaderRow(row)) continue;

          const rawModel = row?.[0]; if (!rawModel) continue;
          const model = stripParen(rawModel);
          if (isNoise(model) || !isValidModel(model)) continue;
          const key = normalizeKey(model);

          // 縦: model, list, cost, type / 横: model, SP_list,SP_cost, NR_list,NR_cost, HNR_list,HNR_cost
          const hasTypeCol = row.length>=4 && String(row[3]||"").trim()!=="";
          const looksWide  = row.length>=6 && (String(row[1]||"")!=="" || String(row[3]||"")!=="" || String(row[5]||"")!=="");

          if (hasTypeCol && !looksWide){
            const listPrice = row?.[1] ?? ""; const cost = row?.[2] ?? "";
            let type = String(row?.[3] ?? "SP").toUpperCase().replace(/[^A-Z]/g,""); if (!["SP","NR","HNR"].includes(type)) type="SP";
            const en = ensureEntry(key, model); const arr = en.variantsByType[type];
            const sig = String(listPrice)+"|||"+String(cost);
            const dup = arr.some(v => (String(v.listPrice)+"|||"+String(v.cost))===sig);
            if (!dup && arr.length<2){ arr.push({listPrice,cost}); kept++; byTypeCount[type]++; }
          } else {
            const en = ensureEntry(key, model);
            const pushIf = (type, lp, cs) => {
              const listPrice = lp ?? "", cost = cs ?? "";
              if (listPrice==="" && cost==="") return;
              const arr = en.variantsByType[type];
              const sig = String(listPrice)+"|||"+String(cost);
              const dup = arr.some(v => (String(v.listPrice)+"|||"+String(v.cost))===sig);
              if (!dup && arr.length<2){ arr.push({listPrice,cost}); kept++; byTypeCount[type]++; }
            };
            pushIf("SP", row?.[1], row?.[2]);
            pushIf("NR", row?.[3], row?.[4]);
            pushIf("HNR", row?.[5], row?.[6]);
          }
        }
        resolve({ map:m, meta:{ rows:rows.length, kept, uniqueKeys:m.size, byTypeCount } });
      },
      error: (err) => reject(err)
    });
  });
}

/* ===== PDFテキスト抽出（テキストPDFのみ） ===== */
async function extractTextFromPdf(file){
  try{
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
    let text = "";
    let collected = 0;
    for (let i=1; i<=pdf.numPages; i++){
      const page = await pdf.getPage(i);
      const content = await page.getTextContent({ includeMarkedContent: true });
      const chunk = content.items.map(it => (it.str ? it.str : "")).join("\n");
      if (chunk.trim()) collected++;
      text += chunk + "\n";
      // 先頭3ページで十分拾えたら軽量打ち切り
      if (i>=3 && collected>0 && text.length>1000) break;
    }
    text = (text||"").trim();
    if (!text) Toast("画像ベースのため抽出できません（テキストなし）","error");
    return text;
  }catch(e){
    console.error("PDF extract error:", e);
    Toast("PDF抽出に失敗しました: " + (e?.message||e),"error");
    return "";
  }
}

/* ===== UI refs ===== */
const csvInput = document.getElementById("csvInput");
const csvMeta  = document.getElementById("csvMeta");
const pdfInput = document.getElementById("pdfInput");
const pdfStatus= document.getElementById("pdfStatus");
const addRowBtn= document.getElementById("addRowBtn");
const estimateBtn=document.getElementById("estimateBtn");
const tbody    = document.getElementById("tbody");
const grid     = document.getElementById("grid");
const dlgMask  = document.getElementById("dlgMask");
const dlgTitle = document.getElementById("dlgTitle");
const dlgText  = document.getElementById("dlgText");
const dlgClose = document.getElementById("dlgClose");
dlgClose.addEventListener("click", ()=> dlgMask.style.display="none");
dlgMask.addEventListener("click", (e)=>{ if (e.target===dlgMask) dlgMask.style.display="none"; });

function openDialog(title, text){
  dlgTitle.textContent = title;
  dlgText.value = text;
  dlgMask.style.display = "flex";
  dlgText.focus(); dlgText.select();
}

/* ===== 表描画 ===== */
function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
function renderRows(){
  if (!ROWS.length){
    tbody.innerHTML = '<tr><td colspan="6" style="padding:16px;text-align:center;color:#047857">ここに結果が表示されます</td></tr>';
    addRowBtn.style.display = INPLACE ? "" : "none";
    estimateBtn.textContent = "見積表示";
    return;
  }
  const rowsHtml = ROWS.map((r,idx)=>{
    const rowCls = r.found ? "" : "row-warn";
    const modelCell = INPLACE
      ? `<input data-id="${r.id}" data-k="model" value="${escapeHtml(r.model)}" style="width:100%;padding:6px 8px;border:1px solid #e5e7eb;border-radius:6px" />`
      : `<span style="font-weight:600;color:#064e3b">${r.modelLabel ? "品名・型式　"+escapeHtml(r.modelLabel) : escapeHtml(r.model)}</span>`;
    const listCell = INPLACE
      ? `<input data-id="${r.id}" data-k="listPrice" value="${escapeHtml(r.listPrice)}" placeholder="定価" style="width:100%;padding:6px 8px;border:1px solid #e5e7eb;border-radius:6px" />`
      : (r.listPrice ? `<span>${escapeHtml(jpYen(r.listPrice))}</span>` : `<span class="muted">—</span>`);
    const costCell = INPLACE
      ? `<input data-id="${r.id}" data-k="cost" value="${escapeHtml(r.cost)}" placeholder="仕入" style="width:100%;padding:6px 8px;border:1px solid #e5e7eb;border-radius:6px" />`
      : (r.cost ? `<span>${escapeHtml(jpYen(r.cost))}</span>` : `<span class="muted">—</span>`);
    const noteCell = r.note ? `<span class="${r.found?"ok":"warn"}">${escapeHtml(r.note)}</span>` : (r.found?`<span class="ok">一致</span>`:`<span class="warn">未一致</span>`);
    return `
      <tr class="${rowCls}">
        <td class="idx">${idx+1}</td>
        <td class="model">${modelCell}</td>
        <td class="num">${listCell}</td>
        <td class="num">${costCell}</td>
        <td>${noteCell}</td>
        <td><button class="btn danger" data-del="${r.id}">削除</button></td>
      </tr>`;
  }).join("");
  tbody.innerHTML = rowsHtml;
  addRowBtn.style.display = INPLACE ? "" : "none";
  estimateBtn.textContent = INPLACE ? "決定（見積表示）" : "再編集（見積表示）";
}

/* ===== 行生成・価格解決 ===== */
function buildRowsFromModels(modelList){
  const pickType = (entry) => {
    if (!entry) return { type:"SP", arr:[] };
    if (entry.variantsByType){ for (const t of ["SP","NR","HNR"]){ const arr = entry.variantsByType[t]; if (arr && arr.length) return { type:t, arr }; } return { type:"SP", arr:[] }; }
    return { type:"SP", arr: entry.variants || [] };
  };
  const out=[];
  modelList.forEach((m,occIdx)=>{
    const key = normalizeKey(m);
    const hit = CSV_MAP ? CSV_MAP.get(key) : null;
    const picked = pickType(hit || null);
    const variants = picked.arr.length ? picked.arr.slice(0,2) : [{ listPrice:"", cost:"" }];
    variants.forEach((v,i)=>{
      out.push({
        id: `${key}-${occIdx}-${i}`,
        model: (hit?.model ?? stripParen(m)),
        modelLabel: "", // 編集終了で付与
        listPrice: v.listPrice, cost: v.cost,
        found: !!hit && picked.arr.length>0,
        note: (!!hit && picked.arr.length>0) ? `一致（${picked.type})` : "未一致",
        variantIndex: i, selectedType: picked.type
      });
    });
  });
  return out;
}
function resolvePricesFromCsv(prevRows){
  if (!CSV_MAP) return prevRows;
  const pickType = (entry) => {
    if (!entry) return { type:"SP", arr:[] };
    if (entry.variantsByType){ for (const t of ["SP","NR","HNR"]){ const arr = entry.variantsByType[t]; if (arr && arr.length) return { type:t, arr }; } return { type:"SP", arr:[] }; }
    return { type:"SP", arr: entry.variants || [] };
  };
  return prevRows.map(r=>{
    const key = normalizeKey(r.model||"");
    const hit = key ? CSV_MAP.get(key) : null;
    let type = r.selectedType; let arr = [];
    if (hit?.variantsByType){
      arr = type ? (hit.variantsByType[type]||[]) : [];
      if (!arr.length){ const p = pickType(hit); type=p.type; arr=p.arr; }
    }else{ const p = pickType(hit||null); type=p.type; arr=p.arr; }
    if (arr.length){ const vi = Number.isInteger(r?.variantIndex) ? r.variantIndex : 0; const v = arr[vi] || arr[0];
      return { ...r, listPrice:v.listPrice, cost:v.cost, found:true, note:`一致（${type})`, selectedType:type }; }
    return { ...r, found:false, note:"未一致", selectedType:type||r.selectedType };
  });
}

/* ===== 事件束 ===== */
// CSV
csvInput.addEventListener("change", async (e)=>{
  const f = e.target.files?.[0]; if (!f) return;
  try{
    const { map, meta } = await parseCsvToMap(f);
    CSV_MAP = map;
    csvMeta.textContent = `${f.name} / 有効行: ${meta.kept} / 一意型式: ${meta.uniqueKeys}件`;
    ROWS = resolvePricesFromCsv(ROWS);
    renderRows();
    Toast("価格マスタを読み込みました");
  }catch(err){
    console.error(err); Toast("CSV読み込みに失敗しました","error");
  }
});

// PDF
pdfInput.addEventListener("change", async (e)=>{
  const f = e.target.files?.[0]; if (!f) return;
  pdfStatus.textContent = "抽出中...";
  const text = await extractTextFromPdf(f);
  if (!text){ pdfStatus.textContent = "画像ベースの可能性（抽出不可）"; return; }
  pdfStatus.textContent = text.slice(0,80) + "...";
  const models = parseModelList(text);
  ROWS = buildRowsFromModels(models);
  INPLACE = true; renderRows();
  Toast("PDFを優先して見積表を更新（型式のみ表示）");
});

// 編集/削除/行追加
addRowBtn.addEventListener("click", ()=>{
  ROWS.push({ id:`ROW-${Date.now()}-${Math.random().toString(36).slice(2,8)}`, model:"", modelLabel:"", listPrice:"", cost:"", found:false, note:"手入力", variantIndex:0, selectedType:undefined });
  renderRows();
});
tbody.addEventListener("click", (e)=>{
  const id = e.target.getAttribute?.("data-del");
  if (id){ ROWS = ROWS.filter(r=>r.id!==id); renderRows(); }
});
tbody.addEventListener("input", (e)=>{
  const id = e.target.getAttribute?.("data-id");
  const k  = e.target.getAttribute?.("data-k");
  if (!id || !k) return;
  const v = e.target.value;
  ROWS = ROWS.map(r=>{
    if (r.id !== id) return r;
    let nextVal = v;
    if (k==="listPrice" || k==="cost") nextVal = String(v).replace(/^[^0-9-]+/,"");
    return { ...r, [k]:nextVal };
  });
});

// 見積表示（編集終了 → 品名：型式 付与）
estimateBtn.addEventListener("click", ()=>{
  if (INPLACE){
    ROWS = resolvePricesFromCsv(ROWS).map(r => ({ ...r, modelLabel: labelFromPdfText(r.model||"", PDF_TEXT) || r.model }));
    INPLACE = false; renderRows();
    Toast("編集確定：品名：型式で表示しました");
    addRowBtn.style.display = "none";
    return;
  }
  if (ROWS.length>0){
    INPLACE = true; renderRows();
    Toast("再編集モード：型式のみ表示に戻しました");
    addRowBtn.style.display = "";
    return;
  }
  Toast("PDFから型式を抽出してください","error");
});

// 列コピー（型式=常に「品名：型式」でコピー。CRLF）
grid.addEventListener("click", async (e)=>{
  const col = e.target.getAttribute?.("data-copycol");
  if (!col) return;
  const ci = Number(col);
  const pick = (r) => {
    if (ci===1){
      const label = !INPLACE ? (r.modelLabel || labelFromPdfText(r.model||"", PDF_TEXT)) : labelFromPdfText(r.model||"", PDF_TEXT);
      return String(label || r.model || "");
    }
    if (ci===2) return r.listPrice ? jpYen(r.listPrice) : "";
    if (ci===3) return r.cost ? jpYen(r.cost) : "";
    return "";
  };
  const text = ROWS.map(pick).join("\r\n");
  if (!text){ Toast("コピー対象がありません"); return; }
  try{
    const ok = await tryWriteClipboard(text);
    if (ok){ Toast("コピーしました"); return; }
    throw new Error("clipboard blocked");
  }catch{
    const title = (ci===1?"型式":ci===2?"定価":"仕入") + " 列のコピー用テキスト";
    Toast("クリップボードに直接コピーできませんでした（ブラウザの制限）","error");
    dlgTitle.textContent = title; dlgText.value = text; dlgMask.style.display = "flex";
    dlgText.focus(); dlgText.select();
  }
});
</script>
</body>
</html>
