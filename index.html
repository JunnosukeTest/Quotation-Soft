<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>日本語OCRツール（単一HTML / PDF & 画像対応）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --green:#059669; --green-2:#065f46; --line:#e5e7eb; }
    body{margin:0;background:#fff;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:#111827}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    h1{margin:0 0 4px;color:var(--green-2);font-size:22px;font-weight:800}
    .sub{color:#047857;font-size:12px}
    .card{border:1px solid #a7f3d0;border-radius:16px;margin:20px 0;overflow:hidden}
    .card h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--line);color:var(--green-2);font-size:16px}
    .body{padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .dz{border:2px dashed #6ee7b7;border-radius:16px;padding:22px;text-align:center;cursor:pointer;background:#fff}
    .dz p{margin:0;color:#047857}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #a7f3d0;background:#fff;color:#047857;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--green);border-color:var(--green);color:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .ctrls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
    .ctrls label{font-size:13px;color:#374151}
    .ctrls input,.ctrls select{padding:6px 8px;border:1px solid #cbd5e1;border-radius:8px}
    textarea{width:100%;min-height:320px;padding:12px;border:1px solid #cbd5e1;border-radius:12px;font-family:ui-monospace,Consolas,Menlo,monospace}
    .prog{height:8px;background:#ecfeff;border:1px solid #bae6fd;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:#0ea5e9;transition:width .2s}
    .hint{font-size:12px;color:#475569;margin-top:6px}
    .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 15px rgba(0,0,0,.2);opacity:0;transform:translateY(8px);transition:all .2s;z-index:60}
    .toast.show{opacity:1;transform:translateY(0)}
    .toast.err{background:#9f1239}
    .small{font-size:12px;color:#6b7280}
  </style>
</head>
<body>
  <div class="wrap">
    <header style="display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:8px">
      <div>
        <h1>日本語OCRツール</h1>
        <div class="sub">PDF（テキスト/画像）・画像（PNG/JPG）対応 / 単一HTML / GitHub Pages可</div>
      </div>
    </header>

    <section class="card">
      <h2>1. 入力</h2>
      <div class="body">
        <div class="row">
          <div id="drop" class="dz" tabindex="0">
            <p>PDFや画像をドロップ / クリックで選択</p>
            <input id="file" type="file" accept="application/pdf,image/png,image/jpeg,.pdf" style="display:none" />
          </div>
        </div>
        <div class="ctrls">
          <label>言語:
            <select id="lang">
              <option value="jpn+eng">日本語＋英語（推奨）</option>
              <option value="jpn">日本語のみ（やや速い）</option>
              <option value="eng">英語のみ（速い）</option>
            </select>
          </label>
          <label>OCR対象ページ（PDF）:
            <input id="maxPages" type="number" min="1" max="20" value="3" style="width:70px" />
          </label>
          <label>拡大率:
            <input id="scale" type="number" step="0.1" min="1" max="3" value="1.8" style="width:70px" />
          </label>
          <button id="run" class="btn primary" disabled>OCR開始</button>
        </div>
        <div class="prog"><div id="bar" class="bar"></div></div>
        <div id="hint" class="hint"></div>
      </div>
    </section>

    <section class="card">
      <h2>2. 結果</h2>
      <div class="body">
        <textarea id="out" placeholder="ここにOCR結果が表示されます"></textarea>
        <div class="row" style="margin-top:10px">
          <button id="copy" class="btn">コピー</button>
          <button id="save" class="btn">.txt保存</button>
          <span id="meta" class="small"></span>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Tips</h2>
      <div class="body small">
        ・GitHub Pages や HTTPS 環境推奨（Clipboard API などの制約回避）<br>
        ・日本語の認識精度が悪いときは「拡大率」を 2.0〜2.5 に上げてください（重くなります）<br>
        ・超巨大PDFは「OCR対象ページ」を絞って部分確認→必要に応じて増やすのが実務的です
      </div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <!-- ライブラリ（CDN） -->
  <script>
    // 動的ロード（順次）
    const loadScript = (src) => new Promise((res, rej) => {
      const s = document.createElement("script"); s.src = src; s.async = true; s.onload = res; s.onerror = rej; document.head.appendChild(s);
    });

    async function ensurePdfJs() {
      if (window.pdfjsLib?.getDocument) return true;
      await loadScript("https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.js");
      try {
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.min.js";
      } catch {}
      return true;
    }
    async function ensureTess() {
      if (window.Tesseract) return true;
      await loadScript("https://cdn.jsdelivr.net/npm/tesseract.js@5.0.5/dist/tesseract.min.js");
      return true;
    }
  </script>

  <script>
    // UI refs
    const drop = document.getElementById("drop");
    const file = document.getElementById("file");
    const runBtn = document.getElementById("run");
    const out = document.getElementById("out");
    const copyBtn = document.getElementById("copy");
    const saveBtn = document.getElementById("save");
    const hint = document.getElementById("hint");
    const bar = document.getElementById("bar");
    const meta = document.getElementById("meta");
    const langSel = document.getElementById("lang");
    const maxPagesInput = document.getElementById("maxPages");
    const scaleInput = document.getElementById("scale");
    const toastEl = document.getElementById("toast");

    let currentFile = null;

    // Toast
    let toastTimer = null;
    function toast(msg, kind="") {
      toastEl.textContent = msg;
      toastEl.classList.remove("err","show");
      if (kind === "error") toastEl.classList.add("err");
      void toastEl.offsetWidth;
      toastEl.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toastEl.classList.remove("show"), 1800);
    }

    // Clipboard
    async function copyText(text) {
      try {
        if (navigator?.clipboard && window?.isSecureContext) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch {}
      try {
        const ta = document.createElement("textarea");
        ta.value = text; ta.setAttribute("readonly","");
        ta.style.position="fixed"; ta.style.top="-1000px"; ta.style.left="-1000px";
        document.body.appendChild(ta); ta.focus(); ta.select(); ta.setSelectionRange(0, ta.value.length);
        const ok = document.execCommand && document.execCommand("copy");
        document.body.removeChild(ta); return !!ok;
      } catch { return false; }
    }

    // 入力イベント
    drop.addEventListener("click", ()=> file.click());
    drop.addEventListener("dragover", e => e.preventDefault());
    drop.addEventListener("drop", (e)=>{ e.preventDefault(); handleFile(e.dataTransfer.files?.[0]); });
    file.addEventListener("change", (e)=> handleFile(e.target.files?.[0]));

    async function handleFile(f){
      if (!f) return;
      currentFile = f;
      runBtn.disabled = false;
      hint.textContent = `${f.name} / ${(f.size/1024/1024).toFixed(2)} MB`;
      out.value = "";
      meta.textContent = "";
      bar.style.width = "0%";
      toast("ファイルを読み込みました");
    }

    // 進捗表示
    function setProgress(p) {
      bar.style.width = Math.max(0, Math.min(100, p)) + "%";
    }

    // OCR 本体
    async function runOcr() {
      if (!currentFile) { toast("ファイルを選択してください","error"); return; }
      runBtn.disabled = true; setProgress(0); out.value = ""; meta.textContent = ""; hint.textContent = "初期化中…";

      const lang = langSel.value || "jpn+eng";
      const isPdf = /pdf$/i.test(currentFile.type) || /\.pdf$/i.test(currentFile.name);
      const startedAt = performance.now();

      try {
        await ensureTess();
        if (isPdf) await ensurePdfJs();

        let text = "";
        if (isPdf) {
          text = await extractPdfTextOrOcr(currentFile, { lang, maxPages: parseInt(maxPagesInput.value||"3",10), scale: parseFloat(scaleInput.value||"1.8") });
        } else {
          text = await ocrImage(currentFile, { lang, scale: parseFloat(scaleInput.value||"1.8") });
        }

        if (!text) {
          hint.textContent = "抽出結果が空でした";
          toast("抽出に失敗しました","error");
        } else {
          out.value = text.trim();
          hint.textContent = "完了";
          toast("OCR完了");
        }
      } catch (e) {
        console.error(e);
        toast("実行中にエラーが発生しました","error");
        hint.textContent = "エラー";
      } finally {
        const ms = Math.round(performance.now() - startedAt);
        meta.textContent = `処理時間: ${(ms/1000).toFixed(1)}s`;
        runBtn.disabled = false;
        setProgress(100);
      }
    }

    // PDF: テキスト抽出→空ならOCR
    async function extractPdfTextOrOcr(file, { lang, maxPages=3, scale=1.8 }) {
      let text = "";
      try {
        const buf = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
        let collected = 0;
        for (let i=1;i<=pdf.numPages;i++){
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          const chunk = content.items.map(it => (it.str ? it.str : "")).join("\n");
          if (chunk.trim()) collected++;
          text += chunk + "\n";
          setProgress(Math.min(50, (i/pdf.numPages)*50));
          if (i>=3 && collected>0 && text.length>1000) break; // 軽量化
        }
        text = (text||"").trim();
        if (text) return text;
      } catch (e) {
        console.warn("pdf text extract failed, fallback to OCR", e);
      }
      // OCR フォールバック
      return await ocrPdf(file, { lang, maxPages, scale, startProgress:50 });
    }

    // PDF OCR
    async function ocrPdf(file, { lang="jpn+eng", maxPages=3, scale=1.8, startProgress=0 } = {}) {
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;

      const pages = Math.min(pdf.numPages, Math.max(1, maxPages));
      const langPath = "https://tessdata.projectnaptha.com/4.0.0";
      let outText = "";

      for (let i=1;i<=pages;i++){
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale });
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d", { willReadFrequently:true });
        canvas.width = Math.ceil(viewport.width);
        canvas.height = Math.ceil(viewport.height);
        await page.render({ canvasContext: ctx, viewport }).promise;

        hint.textContent = `OCR中 (${i}/${pages})…`;
        const res = await Tesseract.recognize(canvas, lang, { langPath });
        outText += (res?.data?.text || "") + "\n";

        setProgress(startProgress + Math.round((i/pages) * (100-startProgress)));
      }
      return outText.trim();
    }

    // 画像 OCR
    async function ocrImage(file, { lang="jpn+eng", scale=1.8 } = {}) {
      const img = await readImage(file);
      // 画像の最長辺を scale 倍に（大きすぎる画像は軽く縮小）
      const maxW = img.width * scale, maxH = img.height * scale;
      const canvas = document.createElement("canvas");
      canvas.width = Math.min(maxW, 2200);
      canvas.height = Math.min(maxH, 2200 * (img.height/img.width));
      const ctx = canvas.getContext("2d", { willReadFrequently:true });
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      hint.textContent = "OCR中…";
      const langPath = "https://tessdata.projectnaptha.com/4.0.0";
      const res = await Tesseract.recognize(canvas, lang, { langPath });
      setProgress(100);
      return (res?.data?.text || "").trim();
    }

    function readImage(file){
      return new Promise((resolve, reject)=>{
        const img = new Image();
        img.onload = ()=> resolve(img);
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }

    // ボタン動作
    runBtn.addEventListener("click", runOcr);
    copyBtn.addEventListener("click", async ()=>{
      const ok = await copyText(out.value || "");
      toast(ok ? "コピーしました" : "コピーに失敗しました"+(window.isSecureContext?"":"（HTTPSで開くと成功しやすいです）"), ok?"":"error");
    });
    saveBtn.addEventListener("click", ()=>{
      const blob = new Blob([out.value || ""], { type:"text/plain;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "ocr_result.txt";
      document.body.appendChild(a); a.click(); a.remove();
    });

    // 初期ロード（tess だけ先読みしておくと初回が早い）
    (async () => {
      try { await ensureTess(); } catch {}
    })();
  </script>
</body>
</html>
